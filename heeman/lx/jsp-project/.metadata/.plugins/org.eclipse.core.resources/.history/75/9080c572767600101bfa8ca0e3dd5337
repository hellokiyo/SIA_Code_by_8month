package myaddrbook;

import java.io.IOException;
import java.util.List;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import addrbook.AddrBookDAO;
import addrbook.AddrBookVO;

@WebServlet("/addrbook.do")
public class AddrbookServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
    
	//addrbook_control 내용 복사해왔음	
	
	@Override
	protected void service(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
		//여기서 addrbook_control.jsp가 하는 일을 수행한다.
		String action = req.getParameter("action");
		System.out.println("action=" + action);
		String forwardPage ="/addrbook_list.jsp";
		AddrBookDAO dao = new AddrBookDAO();
		
		try {
			if("insert".equals(action)) {
				AddrBookVO ab = makeAddrBookFromReq(req);
				dao.insertDB(ab);
				
			} else if("edit".equals(action)) {
				String abIdStr = req.getParameter("ab_id");
				AddrBookVO vo = dao.getDB(Integer.parseInt(abIdStr));
				forwardPage  = "/addrbook_edit_form.jsp";
				req.setAttribute("ab", vo);
				
			}else if("delete".equals(action)) {
				String abIdStr = req.getParameter("ab_id"); 
				int result = dao.deleteDB(Integer.parseInt(abIdStr));
				forwardPage  = "/addrbook_control.jsp?action=list";
				req.setAttribute("ab", result);
			}
			
			else if("list".equals(action)) {
				List<AddrBookVO> list = dao.getDBList();
				req.setAttribute("data", list);
			}
		}catch(Exception e) {
			
		}
		RequestDispatcher rd = getServletContext().getRequestDispatcher(forwardPage);
		//getServletContext는 상위 클래스인 GenericServlet 안에 있고 리턴타입은 ServletContext이다
		//getRequestDispatcher는 ServletContext안에 있고 리턴타입은 RequestDispatcher이다.
		rd.forward(req, res);
		
	}

	private AddrBookVO makeAddrBookFromReq(HttpServletRequest req) {
		AddrBookVO vo  = new AddrBookVO();
		vo.setAbName(req.getParameter("abName"));
		vo.setAbTel(req.getParameter("abTel"));
		vo.setAbComdept(req.getParameter("abComdept"));
		vo.setAbMemo(req.getParameter("abMemo"));
		vo.setAbEmail(req.getParameter("abEmail"));
		vo.setAbBirth(req.getParameter("abBirth"));
		return null;
	}
}
